
    sheetUrl = "https://script.google.com/macros/s/AKfycbxUJo0Zz-qMLvYGlc2122boCrLhDu6MbSVHExX0RHRYZjWO1N-_XBhvd6uJeWYw2IWS/exec";
    secretKey = "LoveHappyjoyjoy";
    
    initEventListeners();
    
    // This is the modified init() function logic
    navigate('dashboard');
    fetchData();
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = setInterval(fetchData, 15000);
            <!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LWS Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes flash-red { 0%, 100% { background-color: #991b1b; } 50% { background-color: #ef4444; } }
        @keyframes flash-purple { 0%, 100% { background-color: #5b21b6; } 50% { background-color: #a78bfa; } }
        .flashing-alert { animation: flash-red 1s infinite; }
        .flashing-duress { animation: flash-purple 1s infinite; }
    </style>
</head>
<body class="bg-gray-800 text-white h-full overflow-hidden">

<div id="dashboardPage" class="h-full flex flex-col"> <header class="flex-shrink-0 bg-gray-900 shadow-lg z-10" style="-webkit-app-region: drag">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <h1 class="text-2xl font-bold text-blue-400">Lone Worker Monitor</h1>
                <div class="flex items-center space-x-2">
                    <span id="statusIndicator" class="h-3 w-3 rounded-full bg-gray-500" title="Connection Status"></span>
                    <span id="lastUpdated" class="text-sm text-gray-500"></span>
                    </div>
            </div>
        </div>
    </header>
    <main class="flex-1 overflow-y-auto p-4">
        <div id="sizeWarningBanner" class="hidden bg-yellow-600 text-white p-3 rounded-lg mb-4 flex justify-between items-center">
            <p><strong>Warning:</strong> The database exceeds 2,500 rows. Please advise the administrator to trim the database for optimal performance.</p>
            <button id="closeWarningBtn" class="ml-4 text-2xl font-bold">Ã—</button>
        </div>
        <div id="workerList" class="space-y-3">
        </div>
    </main>
</div>

<div id="alertOverlay" class="hidden fixed inset-0 z-50 flex-col items-center justify-center flashing-alert text-white p-8">
    <h2 class="text-8xl font-bold animate-pulse">ALERT!</h2>
    <div id="alertDetails" class="mt-8 text-center text-2xl bg-black bg-opacity-30 p-6 rounded-lg">
    </div>
    <button id="acknowledgeBtn" class="mt-12 bg-white text-red-700 font-bold py-4 px-8 rounded-lg text-3xl shadow-2xl">Acknowledge Alert</button>
</div>

<div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-40">
    <div id="alertModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
         <h2 id="alertModalTitle" class="text-xl font-bold mb-2">Alert</h2>
        <p id="alertModalMessage" class="text-gray-300 mb-6"></p>
        <button id="alertModalOkBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-24">OK</button>
    </div>
    <div id="resolveModal" class="hidden bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6">
        <h2 class="text-xl font-bold mb-4 text-yellow-400">Resolve Alert</h2>
        <p class="text-gray-300 mb-4">You are about to manually resolve the alert for <strong id="resolveWorkerName"></strong>. This action will clear their alert status and remove them from the dashboard.</p>
        <p class="text-gray-400 mb-2 text-sm">To confirm, please type the worker's name:</p>
        <input type="text" id="resolveConfirmInput" class="block w-full bg-gray-900 border border-gray-700 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-yellow-500 focus:border-yellow-500" autocomplete="off">
        <div class="mt-6 flex justify-end space-x-3">
            <button id="cancelResolveBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
            <button id="confirmResolveBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" data-name="" data-arrival="">Confirm Resolve</button>
        </div>
    </div>
</div>

<script>
    let setupPage, dashboardPage, googleSheetUrlInput, saveUrlBtn, resetUrlBtn, workerList, statusIndicator, lastUpdatedEl, alertOverlay, alertDetails, acknowledgeBtn, modalBackdrop, alertModal, alertModalTitle, alertModalMessage, alertModalOkBtn, secretKeyInput, sizeWarningBanner, closeWarningBtn, resolveModal, resolveWorkerName, resolveConfirmInput, cancelResolveBtn, confirmResolveBtn;
    let sheetUrl = '';
    let secretKey = '';
    let pollingInterval;
    let lastKnownStatuses = {};
    let alarm;
    let updateChime;

    function navigate(page) {
        if (page === 'setup') {
            // setupPage.classList.remove('hidden'); // This page is removed by setup tool
            dashboardPage.classList.add('hidden');
        } else if (page === 'dashboard') {
            // setupPage.classList.add('hidden'); // This page is removed by setup tool
            dashboardPage.classList.remove('hidden');
            dashboardPage.classList.add('flex');
        }
    }
    
    function showModal(modal, onShow) {
        modalBackdrop.classList.remove('hidden');
        modalBackdrop.classList.add('flex');
        alertModal.classList.add('hidden');
        resolveModal.classList.add('hidden');
        if(modal) {
            modal.classList.remove('hidden');
        }
        if(onShow) onShow();
    }
    function hideModals() {
        modalBackdrop.classList.add('hidden');
        modalBackdrop.classList.remove('flex');
        alertModal.classList.add('hidden');
        resolveModal.classList.add('hidden');
    }
    function showAlert(title, message) { 
        if (!alertModalTitle) { console.error("showAlert called before elements were initialized."); return; }
        alertModalTitle.textContent = title; 
        alertModalMessage.textContent = message; 
        showModal(alertModal);
    }
    
    async function initAudio() {
        if (alarm) return;
        await Tone.start();
        alarm = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 0.1 } }).toDestination();
        updateChime = new Tone.Synth().toDestination();
        console.log("Audio context for alarm started.");
    }
    
    function playUpdateSound() {
        initAudio().then(() => {
            const now = Tone.now();
            updateChime.triggerAttackRelease("A4", "16n", now);
            updateChime.triggerAttackRelease("C5", "16n", now + 0.2);
        });
    }
    
    function playAlarm(worker) {
        initAudio().then(() => {
            if (window.electron) window.electron.sendAlert();
            if (!alarm.loop) {
                alarm.loop = new Tone.Loop(time => {
                    alarm.triggerAttackRelease("C5", "8n", time);
                }, "4n").start(0);
            }
            Tone.Transport.start();
            alertDetails.innerHTML = '<p class="font-bold text-4xl">' + worker['Worker Name'] + '</p><p>at ' + worker['Location Name'] + '</p><p class="mt-4 text-red-300 font-bold">' + 
                worker['Alarm Status'] + '</p>';
            alertOverlay.classList.remove('hidden', 'flashing-duress', 'flashing-alert');
            alertOverlay.classList.add('flex');
            if (worker['Alarm Status'] === 'DURESS_CODE_ACTIVATED') {
                alertOverlay.classList.add('flashing-duress');
            } else {
                alertOverlay.classList.add('flashing-alert');
            }
            acknowledgeBtn.dataset.arrivalTime = worker['Arrival Time'];
            acknowledgeBtn.dataset.workerName = worker['Worker Name'];
        });
    }
    
    function stopAlarm() {
        if (Tone.Transport.state === 'started') {
            Tone.Transport.stop();
            Tone.Transport.cancel();
            if(alarm.loop) {
                alarm.loop.dispose();
                alarm.loop = null;
            }
        }
        alertOverlay.classList.add('hidden');
        alertOverlay.classList.remove('flex');
    }

    function fetchData() {
        if (!sheetUrl || !secretKey) return;
        statusIndicator.classList.remove('bg-green-500', 'bg-red-500');
        statusIndicator.classList.add('bg-yellow-500');
        
        const script = document.createElement('script');
        const callbackName = 'jsonp_callback_' + Date.now();
        
        window[callbackName] = function(data) {
            delete window[callbackName];
            document.body.removeChild(script);
            
            if (data.status === 'error' && data.message.includes('Access Denied')) {
                console.error("Access Denied. Check Secret Key.");
                statusIndicator.classList.remove('bg-yellow-500', 'bg-green-500');
                statusIndicator.classList.add('bg-red-500');
                lastUpdatedEl.textContent = 'Access Denied';
                showAlert("Access Denied", "The Secret Key is incorrect. Please contact your administrator.");
                clearInterval(pollingInterval);
                return;
            }
            
            if (Array.isArray(data)) {
                statusIndicator.classList.remove('bg-yellow-500', 'bg-red-500');
                statusIndicator.classList.add('bg-green-500');
                lastUpdatedEl.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
                if (data.length >= 2500) {
                    sizeWarningBanner.classList.remove('hidden');
                }
                processData(data);
            } else {
                console.error("Received non-array data, likely an error from the script:", data);
                statusIndicator.classList.remove('bg-yellow-500', 'bg-green-500');
                statusIndicator.classList.add('bg-red-500');
                lastUpdatedEl.textContent = 'Data error';
            }
        };
        
        script.src = sheetUrl + '?callback=' + callbackName + '&token=' + encodeURIComponent(secretKey);
        
        script.onerror = () => {
            delete window[callbackName];
            if (document.body.contains(script)) {
                document.body.removeChild(script);
            }
            console.error("Fetch error: JSONP request failed. Check the URL and script deployment settings.");
            statusIndicator.classList.remove('bg-yellow-500', 'bg-green-500');
            statusIndicator.classList.add('bg-red-500');
            lastUpdatedEl.textContent = 'Update failed';
            showAlert( "Connection Failed", "Could not fetch data. This can be caused by an incorrect URL or if the Apps Script has not been correctly deployed. Please follow the setup instructions again carefully." );
        };
        
        document.body.appendChild(script);
    }

    function processData(data) {
        const activeStatuses = ["ON SITE", "ALERT SENT", "MISSED_CHECKIN", "EMAIL_1_SENT", "EMAIL_2_SENT", "EMAIL_3_SENT", "EMERGENCY - PANIC BUTTON", "DURESS_CODE_ACTIVATED", "ESCALATION_SENT"];
        const activeWorkers = data.filter(worker => activeStatuses.includes(worker['Alarm Status']));
        
        const statusPriority = {
            "DURESS_CODE_ACTIVATED": 1,
            "EMERGENCY - PANIC BUTTON": 2,
            "ESCALATION_SENT": 3,
            "MISSED_CHECKIN": 4,
            "EMAIL_3_SENT": 5,
            "EMAIL_2_SENT": 6,
            "EMAIL_1_SENT": 7,
            "ALERT SENT": 8,
            "ON SITE": 9
        };
        
        activeWorkers.sort((a,b) => (statusPriority[a['Alarm Status']] || 99) - (statusPriority[b['Alarm Status']] || 99) || a['Worker Name'].localeCompare(b['Worker Name']));
        
        renderWorkers(activeWorkers);
        checkForNewAlerts(activeWorkers);
    }
    
    function renderWorkers(workers) {
        workerList.innerHTML = '';
        if (workers.length === 0) {
            workerList.innerHTML = '<div class="text-center text-gray-500 mt-10"><p class="text-xl">No active workers found.</p><p>The dashboard is polling for updates.</p></div>';
            return;
        }
        
        workers.forEach(worker => {
            let bgColor, textColor, borderColor, flashClass = '';
            
            switch(worker['Alarm Status']) {
                case 'DURESS_CODE_ACTIVATED':
                    bgColor = 'bg-purple-800'; textColor = 'text-white'; borderColor = 'border-purple-400'; flashClass = 'flashing-duress'; break;
                case 'EMERGENCY - PANIC BUTTON':
                    bgColor = 'bg-red-700'; textColor = 'text-white'; borderColor = 'border-red-400'; flashClass = 'flashing-alert'; break;
                case 'ESCALATION_SENT':
                case 'EMAIL_3_SENT':
                case 'EMAIL_2_SENT':
                case 'EMAIL_1_SENT':
                case 'ALERT SENT':
                case 'MISSED_CHECKIN':
                    bgColor = 'bg-yellow-700'; textColor = 'text-white'; borderColor = 'border-yellow-400'; break;
                default:
                    bgColor = 'bg-gray-700'; textColor = 'text-gray-300'; borderColor = 'border-transparent';
            }
            
            const anticipatedTime = new Date(worker['Anticipated Departure Time']).toLocaleTimeString([], 
                { hour: '2-digit', minute: '2-digit' });
            
            let locationLinkHtml = '';
            let contactDetailsHtml = '';
            let resolveButtonHtml = '';
            const isAlertStatus = worker['Alarm Status'] !== 'ON SITE';
            
            if (isAlertStatus) {
                let linkUrl = '#';
                let linkTitle = 'Location not available';
                
                if (worker['Last Known GPS']) {
                    linkUrl = 'http://maps.google.com/?q=' + worker['Last Known GPS'];
                    linkTitle = 'View last known GPS location';
                } else if (worker['Location Address']) {
                    linkUrl = 'http://maps.google.com/?q=' + encodeURIComponent(worker['Location Address']);
                    linkTitle = 'View initial location address';
                }
                
                if(linkUrl !== '#') {
                    locationLinkHtml = '<a href="' + linkUrl + '" target="_blank" title="' + linkTitle + '" class="mt-1 inline-flex items-center text-sm text-blue-300 hover:text-blue-200"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>View Location</a>';
                }
                
                contactDetailsHtml = '<div class="mt-3 pt-2 border-t border-white/20 text-xs space-y-1">' +
                    '<p>Worker: <a href="tel:' + worker['Worker Phone Number'] + '" class="text-blue-300 hover:text-blue-200">' + worker['Worker Phone Number'] + '</a></p>' +
                    '<p>Contact: ' + worker['Emergency Contact Name'] + ' - <a href="tel:' + worker['Emergency Contact Number'] + '" class="text-blue-300 hover:text-blue-200">' + worker['Emergency Contact Number'] + '</a></p>' +
                '</div>';

                resolveButtonHtml = '<button class="resolve-alert-btn mt-3 w-full bg-green-700 hover:bg-green-600 text-white font-bold py-1 px-3 rounded text-sm" data-name="' + worker['Worker Name'] + '" data-arrival="' + worker['Arrival Time'] + '">Manually Resolve Alert</button>';
            }
            
            let lowBatteryIcon = '';
            if (worker.Notes && worker.Notes.includes('LOW BATTERY')) {
                lowBatteryIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block text-red-400 ml-2 animate-pulse" title="Low Battery Warning Received"><path d="M11 7h2a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2Z"/><path d="M19 12h1.5a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5H19"/><path d="M4 12H2.5A1.5 1.5 0 0 0 1 13.5v1A1.5 1.5 0 0 0 2.5 16H4"/></svg>';
            }
            
            const card = document.createElement('div');
            card.className = 'p-4 rounded-lg shadow-md ' + bgColor + ' ' + textColor + ' border-2 ' + borderColor + ' ' + flashClass;
            
            card.innerHTML = '<div class="flex justify-between items-start">' +
                '<div class="flex-1 min-w-0">' +
                    '<p class="font-bold text-xl truncate">' + worker['Worker Name'] + lowBatteryIcon + '</p>' +
                    '<p class="text-sm truncate">' + worker['Location Name'] + '</p>' +
                    locationLinkHtml +
                '</div>' +
                '<div class="text-right flex-shrink-0 ml-4">' +
                    '<p class="font-semibold text-lg">' + worker['Alarm Status'].replace(/_/g, ' ') + '</p>' +
                    '<p class="text-sm">Due: ' + anticipatedTime + '</p>' +
                '</div>' +
            '</div>' +
            contactDetailsHtml + resolveButtonHtml;
            
            workerList.appendChild(card);
        });
    }

    function checkForNewAlerts(workers) {
        const newStatuses = {};
        const criticalAlerts = ['ALERT SENT', 'EMERGENCY - PANIC BUTTON', 'DURESS_CODE_ACTIVATED', 'MISSED_CHECKIN'];
        const updateAlerts = ['EMAIL_1_SENT', 'EMAIL_2_SENT', 'EMAIL_3_SENT', 'ESCALATION_SENT'];
        
        workers.forEach(worker => {
            const key = worker['Worker Name'] + '-' + worker['Arrival Time'];
            const oldStatus = lastKnownStatuses[key];
            const newStatus = worker['Alarm Status'];
            
            newStatuses[key] = newStatus;
            
            if (newStatus !== oldStatus) {
                if (criticalAlerts.includes(newStatus) && !criticalAlerts.includes(oldStatus)) {
                    console.log("NEW CRITICAL ALERT:", worker);
                    playAlarm(worker);
                } else if (updateAlerts.includes(newStatus)) {
                    console.log("ALERT STATUS UPDATE:", worker);
                    playUpdateSound();
                }
            }
        });
        
        lastKnownStatuses = newStatuses;
    }
    
    function acknowledgeAlert() {
        stopAlarm();
        const arrivalTime = acknowledgeBtn.dataset.arrivalTime;
        const workerName = acknowledgeBtn.dataset.workerName;
        const data = {
            "Arrival Time": arrivalTime,
            "Worker Name": workerName,
            Notes: 'Alert acknowledged by monitor at ' + new Date().toISOString()
        };
        const formData = new FormData();
        for (const key in data) {
            formData.append(key, data[key]);
        }
        
        fetch(sheetUrl, {
            method: 'POST',
            mode: 'no-cors',
            body: new URLSearchParams(formData)
        }).then(() => console.log("Acknowledgement sent.")).catch(err => console.error("Failed to send ack:", err));
    }
    
    function sendResolveAlert(workerName, arrivalTime) {
        const data = {
            "Arrival Time": arrivalTime,
            "Worker Name": workerName,
            "Alarm Status": "MONITOR_CLEARED_ALERT",
            "Notes": 'Alert manually resolved by monitor at ' + new Date().toISOString()
        };
        const formData = new FormData();
        for (const key in data) {
            formData.append(key, data[key]);
        }
        
        fetch(sheetUrl, {
            method: 'POST',
            mode: 'no-cors',
            body: new URLSearchParams(formData)
        }).then(() => {
            console.log("Resolve alert sent.");
            hideModals();
            fetchData();
        }).catch(err => {
            console.error("Failed to send resolve alert:", err);
            showAlert("Error", "Could not send resolve alert. Check connection.");
        });
    }
    
    function initEventListeners() {
        document.body.addEventListener('pointerdown', initAudio, { once: true });
        
        // Removed saveUrlBtn and resetUrlBtn listeners
        
        acknowledgeBtn.addEventListener('click', acknowledgeAlert);
        closeWarningBtn.addEventListener('click', () => sizeWarningBanner.classList.add('hidden'));
        alertModalOkBtn.addEventListener('click', hideModals);
        
        workerList.addEventListener('click', (e) => {
            const resolveBtn = e.target.closest('.resolve-alert-btn');
            if (resolveBtn) {
                const workerName = resolveBtn.dataset.name;
                const arrivalTime = resolveBtn.dataset.arrival;
                showModal(resolveModal, () => {
                    resolveWorkerName.textContent = workerName;
                    resolveConfirmInput.value = '';
                    confirmResolveBtn.dataset.name = workerName;
                    confirmResolveBtn.dataset.arrival = arrivalTime;
                    resolveConfirmInput.focus();
                });
            }
        });

        cancelResolveBtn.addEventListener('click', hideModals);
        
        confirmResolveBtn.addEventListener('click', () => {
            const expectedName = confirmResolveBtn.dataset.name;
            const arrivalTime = confirmResolveBtn.dataset.arrival;
            const typedName = resolveConfirmInput.value;
            if (typedName.trim() === expectedName) {
                sendResolveAlert(expectedName, arrivalTime);
            } else {
                showAlert("Incorrect Name", "The name you typed does not match. Alert not resolved.");
                resolveConfirmInput.value = '';
                resolveConfirmInput.focus();
            }
        });
    }

    function init() {
        setupPage = document.getElementById('setupPage');
        dashboardPage = document.getElementById('dashboardPage');
        googleSheetUrlInput = document.getElementById('googleSheetUrl');
        secretKeyInput = document.getElementById('secretKey');
        saveUrlBtn = document.getElementById('saveUrlBtn');
        resetUrlBtn = document.getElementById('resetUrlBtn');
        workerList = document.getElementById('workerList');
        statusIndicator = document.getElementById('statusIndicator');
        lastUpdatedEl = document.getElementById('lastUpdated');
        alertOverlay = document.getElementById('alertOverlay');
        alertDetails = document.getElementById('alertDetails');
        acknowledgeBtn = document.getElementById('acknowledgeBtn');
        modalBackdrop = document.getElementById('modalBackdrop');
        alertModal = document.getElementById('alertModal');
        alertModalTitle = document.getElementById('alertModalTitle');
        alertModalMessage = document.getElementById('alertModalMessage');
        alertModalOkBtn = document.getElementById('alertModalOkBtn');
        sizeWarningBanner = document.getElementById('sizeWarningBanner');
        closeWarningBtn = document.getElementById('closeWarningBtn');
        resolveModal = document.getElementById('resolveModal');
        resolveWorkerName = document.getElementById('resolveWorkerName');
        resolveConfirmInput = document.getElementById('resolveConfirmInput');
        cancelResolveBtn = document.getElementById('cancelResolveBtn');
        confirmResolveBtn = document.getElementById('confirmResolveBtn');

        // --- CORRECTED MONITOR_LOGIN_LOGIC_START ---
        sheetUrl = localStorage.getItem('lwsMonitorUrl');
        secretKey = localStorage.getItem('lwsMonitorKey');
        
        initEventListeners();

        if (sheetUrl && secretKey) {
            // These lines might be present if using the original template directly
            if (googleSheetUrlInput) googleSheetUrlInput.value = sheetUrl;
            if (secretKeyInput) secretKeyInput.value = secretKey;
            navigate('dashboard');
            fetchData();
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(fetchData, 15000);
        } else {
            navigate('setup');
        }
        // --- CORRECTED MONITOR_LOGIN_LOGIC_END ---
    }

    window.addEventListener('load', init);
</script>
</body>
</html>
